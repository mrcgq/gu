# =============================================================================
# æ–‡ä»¶: .github/workflows/release.yml
# æè¿°: PhantomGUI å‘å¸ƒå·¥ä½œæµ
#       åˆ›å»º Tag æ—¶è‡ªåŠ¨æ„å»ºå¹¶å‘å¸ƒ Release
# =============================================================================
name: Release

on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 4.1.0)'
        required: true
        default: '4.1.0'
      prerelease:
        description: 'Is this a pre-release?'
        required: false
        type: boolean
        default: false
      include_core:
        description: 'Include phantom-core.exe (if available)?'
        required: false
        type: boolean
        default: true

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'PhantomGUI/PhantomGUI/PhantomGUI.csproj'
  CONFIGURATION: 'Release'
  APP_NAME: 'PhantomGUI'

jobs:
  # å‡†å¤‡å‘å¸ƒä¿¡æ¯
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_short: ${{ steps.version.outputs.version_short }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
            if [[ "$VERSION" == *"-"* ]]; then
              IS_PRERELEASE="true"
            else
              IS_PRERELEASE="false"
            fi
          fi
          
          VERSION_SHORT=$(echo $VERSION | cut -d'-' -f1)
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_short=$VERSION_SHORT" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          
          echo "## Release Info" >> $GITHUB_STEP_SUMMARY
          echo "- Version: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- Short Version: $VERSION_SHORT" >> $GITHUB_STEP_SUMMARY
          echo "- Pre-release: $IS_PRERELEASE" >> $GITHUB_STEP_SUMMARY

  # æ„å»ºæ‰€æœ‰å¹³å°
  build:
    name: Build ${{ matrix.platform }}
    runs-on: windows-latest
    needs: prepare
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: win-x64
            runtime: win-x64
            arch: x64
          - platform: win-x86
            runtime: win-x86
            arch: x86
          - platform: win-arm64
            runtime: win-arm64
            arch: arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore ${{ env.PROJECT_PATH }} --runtime ${{ matrix.runtime }}

      - name: Update version in project
        run: |
          $projectFile = "${{ env.PROJECT_PATH }}"
          $content = Get-Content $projectFile -Raw
          $content = $content -replace '<Version>.*</Version>', '<Version>${{ needs.prepare.outputs.version_short }}</Version>'
          Set-Content $projectFile $content
          Write-Host "Updated version to ${{ needs.prepare.outputs.version_short }}"

      - name: Build and Publish (Self-Contained)
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} `
            --configuration ${{ env.CONFIGURATION }} `
            --runtime ${{ matrix.runtime }} `
            --self-contained true `
            --output ./publish/self-contained `
            -p:PublishSingleFile=true `
            -p:PublishTrimmed=false `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -p:EnableCompressionInSingleFile=true `
            -p:DebugType=None `
            -p:DebugSymbols=false

      - name: Build and Publish (Framework-Dependent)
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} `
            --configuration ${{ env.CONFIGURATION }} `
            --runtime ${{ matrix.runtime }} `
            --self-contained false `
            --output ./publish/framework-dependent `
            -p:PublishSingleFile=true `
            -p:DebugType=None `
            -p:DebugSymbols=false

      - name: Create Resources directory
        run: |
          $scDir = "./publish/self-contained/Resources/Icons"
          $fdDir = "./publish/framework-dependent/Resources/Icons"
          
          if (-not (Test-Path $scDir)) { New-Item -ItemType Directory -Path $scDir -Force }
          if (-not (Test-Path $fdDir)) { New-Item -ItemType Directory -Path $fdDir -Force }
          
          # å¤åˆ¶å›¾æ ‡æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          $iconSource = "PhantomGUI/PhantomGUI/Resources/Icons"
          if (Test-Path $iconSource) {
            Copy-Item "$iconSource/*" $scDir -Force -ErrorAction SilentlyContinue
            Copy-Item "$iconSource/*" $fdDir -Force -ErrorAction SilentlyContinue
          }

      - name: Download phantom-core (if configured)
        if: ${{ github.event.inputs.include_core == 'true' || github.event.inputs.include_core == '' }}
        continue-on-error: true
        run: |
          # è¿™é‡Œå¯ä»¥ä»å¦ä¸€ä¸ª Release ä¸‹è½½ phantom-core
          # æˆ–è€…ä»æ„å»ºäº§ç‰©ä¸­è·å–
          Write-Host "Note: phantom-core.exe should be added manually or from another workflow"
          
          # åˆ›å»ºå ä½ç¬¦è¯´æ˜æ–‡ä»¶
          $readme = @"
          # Phantom Core
          
          è¯·å°† phantom-core.exe (æˆ– phantom-client.exe) æ”¾ç½®åœ¨æ­¤ç›®å½•ã€‚
          
          ä¸‹è½½åœ°å€: https://github.com/your-org/phantom/releases
          
          æ”¯æŒçš„æ–‡ä»¶å:
          - phantom-core.exe
          - phantom-client.exe
          - phantom.exe
          "@
          
          Set-Content "./publish/self-contained/README-CORE.txt" $readme
          Set-Content "./publish/framework-dependent/README-CORE.txt" $readme

      - name: Create ZIP archives
        run: |
          $version = "${{ needs.prepare.outputs.version }}"
          $platform = "${{ matrix.platform }}"
          
          # Self-contained ç‰ˆæœ¬ (åŒ…å« .NET è¿è¡Œæ—¶ï¼Œä½“ç§¯è¾ƒå¤§ä½†æ— éœ€å®‰è£… .NET)
          $scZip = "${{ env.APP_NAME }}-${version}-${platform}-self-contained.zip"
          Compress-Archive -Path "./publish/self-contained/*" -DestinationPath $scZip -Force
          
          # Framework-dependent ç‰ˆæœ¬ (éœ€è¦ .NET 8 è¿è¡Œæ—¶ï¼Œä½“ç§¯å°)
          $fdZip = "${{ env.APP_NAME }}-${version}-${platform}-portable.zip"
          Compress-Archive -Path "./publish/framework-dependent/*" -DestinationPath $fdZip -Force
          
          Write-Host "Created archives:"
          Get-ChildItem *.zip | Format-Table Name, Length

      - name: Generate file checksums
        run: |
          $files = Get-ChildItem *.zip
          foreach ($file in $files) {
            $hash = (Get-FileHash $file.FullName -Algorithm SHA256).Hash.ToLower()
            "$hash  $($file.Name)" | Out-File -Append checksums.txt
            Write-Host "$($file.Name): $hash"
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.platform }}
          path: |
            *.zip
            checksums.txt
          retention-days: 1

  # åˆ›å»ºå®‰è£…ç¨‹åº (å¯é€‰)
  create-installer:
    name: Create Installer
    runs-on: windows-latest
    needs: [prepare, build]
    if: ${{ !contains(needs.prepare.outputs.version, '-') }}  # ä»…æ­£å¼ç‰ˆæœ¬åˆ›å»ºå®‰è£…ç¨‹åº
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download x64 artifact
        uses: actions/download-artifact@v4
        with:
          name: release-win-x64
          path: ./artifacts

      - name: Extract for installer
        run: |
          Expand-Archive -Path "./artifacts/*self-contained*.zip" -DestinationPath "./installer-source" -Force

      - name: Create Inno Setup script
        run: |
          $version = "${{ needs.prepare.outputs.version_short }}"
          $script = @"
          #define MyAppName "Phantom VPN"
          #define MyAppVersion "$version"
          #define MyAppPublisher "Phantom Team"
          #define MyAppURL "https://github.com/your-org/phantom"
          #define MyAppExeName "PhantomGUI.exe"
          
          [Setup]
          AppId={{8F14E45F-CEEA-46ED-A74F-43F1D2C8D620}
          AppName={#MyAppName}
          AppVersion={#MyAppVersion}
          AppPublisher={#MyAppPublisher}
          AppPublisherURL={#MyAppURL}
          DefaultDirName={autopf}\{#MyAppName}
          DefaultGroupName={#MyAppName}
          AllowNoIcons=yes
          OutputDir=.
          OutputBaseFilename=PhantomGUI-$version-x64-setup
          Compression=lzma2/ultra64
          SolidCompression=yes
          WizardStyle=modern
          PrivilegesRequired=admin
          ArchitecturesInstallIn64BitMode=x64
          
          [Languages]
          Name: "english"; MessagesFile: "compiler:Default.isl"
          Name: "chinesesimplified"; MessagesFile: "compiler:Languages\ChineseSimplified.isl"
          
          [Tasks]
          Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked
          Name: "quicklaunchicon"; Description: "{cm:CreateQuickLaunchIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked; OnlyBelowVersion: 6.1; Check: not IsAdminInstallMode
          
          [Files]
          Source: "installer-source\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs
          
          [Icons]
          Name: "{group}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"
          Name: "{group}\{cm:UninstallProgram,{#MyAppName}}"; Filename: "{uninstallexe}"
          Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: desktopicon
          
          [Run]
          Filename: "{app}\{#MyAppExeName}"; Description: "{cm:LaunchProgram,{#StringChange(MyAppName, '&', '&&')}}"; Flags: nowait postinstall skipifsilent
          "@
          
          Set-Content "setup.iss" $script

      - name: Build installer with Inno Setup
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.2
        with:
          path: setup.iss
          options: /O.

      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: installer-win-x64
          path: "*.exe"
          retention-days: 1

  # å‘å¸ƒ Release
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [prepare, build]
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Prepare release files
        run: |
          mkdir -p release-files
          
          # å¤åˆ¶æ‰€æœ‰ zip æ–‡ä»¶
          find ./artifacts -name "*.zip" -exec cp {} release-files/ \;
          
          # å¤åˆ¶å®‰è£…ç¨‹åºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          find ./artifacts -name "*.exe" -exec cp {} release-files/ \; 2>/dev/null || true
          
          # åˆå¹¶æ‰€æœ‰ checksums
          echo "# SHA256 Checksums" > release-files/checksums-sha256.txt
          echo "" >> release-files/checksums-sha256.txt
          find ./artifacts -name "checksums.txt" -exec cat {} >> release-files/checksums-sha256.txt \;
          
          echo "Release files:"
          ls -la release-files/

      - name: Generate changelog
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ª tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -n "$PREV_TAG" ]; then
            echo "Changes since $PREV_TAG:"
            CHANGES=$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "Initial release"
            CHANGES="Initial release"
          fi
          
          # å†™å…¥ changelog æ–‡ä»¶
          cat > CHANGELOG.md << EOF
          ## What's Changed
          
          $CHANGES
          
          ## Downloads
          
          | File | Description |
          |------|-------------|
          | \`*-self-contained.zip\` | ç‹¬ç«‹ç‰ˆæœ¬ï¼ŒåŒ…å« .NET è¿è¡Œæ—¶ï¼Œæ— éœ€å®‰è£…ä»»ä½•ä¾èµ– |
          | \`*-portable.zip\` | ä¾¿æºç‰ˆæœ¬ï¼Œéœ€è¦å®‰è£… [.NET 8.0 Desktop Runtime](https://dotnet.microsoft.com/download/dotnet/8.0) |
          | \`*-setup.exe\` | Windows å®‰è£…ç¨‹åº (ä»… x64) |
          
          ## System Requirements
          
          - **æ“ä½œç³»ç»Ÿ**: Windows 10 1903+ / Windows 11
          - **è¿è¡Œæ—¶**: .NET 8.0 Desktop Runtime (portable ç‰ˆæœ¬éœ€è¦)
          - **æ¶æ„**: x64 / x86 / ARM64
          
          ## Checksums (SHA256)
          
          è§ \`checksums-sha256.txt\`
          
          EOF
          
          cat CHANGELOG.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: "Phantom VPN v${{ needs.prepare.outputs.version }}"
          tag_name: "v${{ needs.prepare.outputs.version }}"
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ needs.prepare.outputs.is_prerelease == 'true' }}
          files: |
            release-files/*
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update latest release badge
        if: ${{ needs.prepare.outputs.is_prerelease != 'true' }}
        run: |
          echo "âœ… Release v${{ needs.prepare.outputs.version }} published successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“¦ Download: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY

  # æ¸…ç†æ—§çš„æ„å»ºäº§ç‰©
  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    needs: release
    if: always()
    
    steps:
      - name: Delete artifacts
        uses: geekyeggo/delete-artifact@v4
        with:
          name: |
            release-*
            installer-*
          failOnError: false
