# =============================================================================
# 文件: .github/workflows/release.yml
# 描述: PhantomGUI 发布工作流
# =============================================================================
name: Release

on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 4.1.0)'
        required: true
        default: '4.1.0'
      prerelease:
        description: 'Is this a pre-release?'
        required: false
        type: boolean
        default: false

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'PhantomGUI.csproj'
  CONFIGURATION: 'Release'
  APP_NAME: 'PhantomGUI'

jobs:
  # 准备发布信息
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_short: ${{ steps.version.outputs.version_short }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
      
    steps:
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
            if [[ "$VERSION" == *"-"* ]]; then
              IS_PRERELEASE="true"
            else
              IS_PRERELEASE="false"
            fi
          fi
          
          VERSION_SHORT=$(echo $VERSION | cut -d'-' -f1)
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_short=$VERSION_SHORT" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          
          echo "## Release Info" >> $GITHUB_STEP_SUMMARY
          echo "- Version: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- Pre-release: $IS_PRERELEASE" >> $GITHUB_STEP_SUMMARY

  # 构建所有平台
  build:
    name: Build ${{ matrix.platform }}
    runs-on: windows-latest
    needs: prepare
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: win-x64
            runtime: win-x64
          - platform: win-x86
            runtime: win-x86
          - platform: win-arm64
            runtime: win-arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore ${{ env.PROJECT_PATH }} --runtime ${{ matrix.runtime }}

      - name: Update version
        run: |
          $version = "${{ needs.prepare.outputs.version_short }}"
          $content = Get-Content ${{ env.PROJECT_PATH }} -Raw
          $content = $content -replace '<Version>.*?</Version>', "<Version>$version</Version>"
          Set-Content ${{ env.PROJECT_PATH }} $content
          Write-Host "Updated version to $version"

      - name: Publish (Self-Contained)
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} `
            --configuration ${{ env.CONFIGURATION }} `
            --runtime ${{ matrix.runtime }} `
            --self-contained true `
            --output ./publish/self-contained `
            -p:PublishSingleFile=true `
            -p:PublishTrimmed=false `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -p:EnableCompressionInSingleFile=true `
            -p:DebugType=None `
            -p:DebugSymbols=false

      - name: Publish (Framework-Dependent)
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} `
            --configuration ${{ env.CONFIGURATION }} `
            --runtime ${{ matrix.runtime }} `
            --self-contained false `
            --output ./publish/framework-dependent `
            -p:PublishSingleFile=true `
            -p:DebugType=None `
            -p:DebugSymbols=false

      - name: Create ZIP archives
        run: |
          $version = "${{ needs.prepare.outputs.version }}"
          $platform = "${{ matrix.platform }}"
          
          # Self-contained 版本
          $scZip = "${{ env.APP_NAME }}-${version}-${platform}-self-contained.zip"
          Compress-Archive -Path "./publish/self-contained/*" -DestinationPath $scZip -Force
          
          # Framework-dependent 版本
          $fdZip = "${{ env.APP_NAME }}-${version}-${platform}-portable.zip"
          Compress-Archive -Path "./publish/framework-dependent/*" -DestinationPath $fdZip -Force
          
          Write-Host "Created archives:"
          Get-ChildItem *.zip | Format-Table Name, Length

      - name: Generate checksums
        run: |
          $files = Get-ChildItem *.zip
          foreach ($file in $files) {
            $hash = (Get-FileHash $file.FullName -Algorithm SHA256).Hash.ToLower()
            "$hash  $($file.Name)" | Out-File -Append checksums.txt
          }
          Get-Content checksums.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.platform }}
          path: |
            *.zip
            checksums.txt
          retention-days: 1

  # 发布 Release
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [prepare, build]
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Prepare release files
        run: |
          mkdir -p release-files
          
          # 复制所有 zip 文件
          find ./artifacts -name "*.zip" -exec cp {} release-files/ \;
          
          # 合并 checksums
          echo "# SHA256 Checksums" > release-files/checksums-sha256.txt
          echo "" >> release-files/checksums-sha256.txt
          find ./artifacts -name "checksums.txt" -exec cat {} >> release-files/checksums-sha256.txt \;
          
          echo "Release files:"
          ls -la release-files/

      - name: Create changelog
        run: |
          cat > CHANGELOG.md << 'EOF'
          ## Phantom VPN v${{ needs.prepare.outputs.version }}
          
          ### Downloads
          
          | 文件 | 说明 |
          |------|------|
          | `*-self-contained.zip` | 独立版本，包含 .NET 运行时，开箱即用 |
          | `*-portable.zip` | 便携版本，需要安装 [.NET 8.0 Desktop Runtime](https://dotnet.microsoft.com/download/dotnet/8.0) |
          
          ### System Requirements
          
          - **操作系统**: Windows 10 1903+ / Windows 11
          - **运行时**: .NET 8.0 Desktop Runtime (portable 版本需要)
          - **架构**: x64 / x86 / ARM64
          
          ### Notes
          
          - 首次运行请将 `phantom-core.exe` 放置在程序同目录
          - FakeTCP/eBPF 模式需要管理员权限
          
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: "Phantom VPN v${{ needs.prepare.outputs.version }}"
          tag_name: ${{ github.event_name == 'workflow_dispatch' && format('v{0}', needs.prepare.outputs.version) || github.ref_name }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ needs.prepare.outputs.is_prerelease == 'true' }}
          files: release-files/*
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 清理
  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    needs: release
    if: always()
    
    steps:
      - name: Delete artifacts
        uses: geekyeggo/delete-artifact@v4
        with:
          name: release-*
          failOnError: false
